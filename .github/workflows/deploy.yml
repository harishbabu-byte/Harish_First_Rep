name: Deploy Using Self-Hosted Runner

on:
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  build:
    name: Build & Upload Artifact
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create artifact contents
        run: |
          mkdir -p dist
          echo "Built from commit: $GITHUB_SHA" > dist/build.txt
          echo "<h1>Hello from build job</h1>" > dist/index.html

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: webapp
          path: dist/
          retention-days: 1

  deploy:
    name: Deploy on Self-Hosted Windows Runner
    needs: build
    runs-on:
      - self-hosted
      - Windows
      - X64

    steps:
      - name: Checkout to get deploy.sh
        uses: actions/checkout@v4

      - name: Download artifact from build
        uses: actions/download-artifact@v4
        with:
          name: webapp
          path: artifact/

      - name: List downloaded files (Windows)
        run: dir artifact/

      # Run deploy.sh using Git Bash on Windows
      - name: Run deployment script
        shell: bash
        run: |
          chmod +x ./deploy.sh || true
          ./deploy.sh artifact/
